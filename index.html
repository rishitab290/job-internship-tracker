<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Job Tracker — Dashboard</title>
    <style>
        body{font-family:Arial,Helvetica,sans-serif;background:#f0f8ff;margin:20px}
        h1{text-align:center}
        h2{text-align:center}
        .container{max-width:900px;margin:0 auto}
        form{background:#fff;padding:12px;border-radius:6px;border:1px solid #dcdcdc;margin-bottom:12px}
        input,select,textarea,button{width:100%;padding:8px;margin-top:6px;box-sizing:border-box}
        .row{display:flex;gap:12px}
        .col{flex:1}
        #jobList{background:#fff;padding:12px;border-radius:6px;border:1px solid #dcdcdc}
        .job{padding:10px;border-bottom:1px solid #eee}
        .small{font-size:0.9em;color:#555}
        .controls{display:flex;gap:8px;flex-wrap:wrap}
        .btn{padding:8px;border:none;border-radius:4px;cursor:pointer}
        .btn-danger{background:#ff4d4d;color:white}
        .btn-primary{background:#2b7cff;color:white}
    </style>
</head>
<body>
<div class="container">
    <h1>J.I.T</h1>
    <h2>Job.Internship.Tracker</h2>

    <!-- Auth -->
    <div id="authPanel">
        <form id="signupForm">
            <h3>Create account</h3>
            <input id="signupEmail" type="email" placeholder="Email" required />
            <input id="signupPassword" type="password" placeholder="Password (min 6)" required />
            <button class="btn btn-primary" type="submit">Sign Up</button>
        </form>

        <form id="loginForm">
            <h3>Log in</h3>
            <input id="loginEmail" type="email" placeholder="Email" required />
            <input id="loginPassword" type="password" placeholder="Password" required />
            <button class="btn btn-primary" type="submit">Log In</button>
        </form>
    </div>

    <!-- Tracker (hidden until auth) -->
    <div id="tracker" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong id="userEmail"></strong></div>
            <div class="controls">
                <button id="signOutBtn" class="btn">Sign out</button>
            </div>
        </div>

        <!-- Add job -->
        <form id="jobForm">
            <h3>Add job</h3>
            <input id="company" placeholder="Company" required />
            <input id="position" placeholder="Position" required />
            <div class="row">
                <div class="col">
                    <label class="small">Date applied</label>
                    <input id="date" type="date" required />
                </div>
                <div class="col">
                    <label class="small">Status</label>
                    <select id="status">
                        <option>Applied</option>
                        <option>Interviewing</option>
                        <option>Offer</option>
                        <option>Rejected</option>
                    </select>
                </div>
            </div>
            <input id="link" placeholder="Application link (optional)" />
            <textarea id="notes" rows="3" placeholder="Notes (optional)"></textarea>
            <label class="small">Resume (optional)</label>
            <input id="resume" type="file" accept=".pdf,.doc,.docx" />
            <button class="btn btn-primary" type="submit">Add job & generate edit link</button>
        </form>

        <!-- Filters -->
        <div style="display:flex;gap:8px;margin:10px 0">
            <input id="search" placeholder="Search company or position..." />
            <select id="filterStatus">
                <option value="">All statuses</option>
                <option>Applied</option>
                <option>Interviewing</option>
                <option>Offer</option>
                <option>Rejected</option>
            </select>
        </div>

        <!-- Jobs -->
        <div id="jobList"><p class="small">Loading...</p></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import { getDatabase, ref, push, set, onValue, update, remove } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-storage.js";

    // Firebase config with analytics
    const firebaseConfig = {
      apiKey: "AIzaSyBSUy5xyp9JQ77cPnoJ7L_Ydh9-Kc0l1N8",
      authDomain: "job-internship-tracker.firebaseapp.com",
      databaseURL: "https://job-internship-tracker-default-rtdb.firebaseio.com",
      projectId: "job-internship-tracker",
      storageBucket: "job-internship-tracker.firebasestorage.app",
      messagingSenderId: "346187501673",
      appId: "1:346187501673:web:826c199979ae737b6b92f8",
      measurementId: "G-HYPHMR9YHG"
    };

    // init
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);

    // UI refs
    const signupForm = document.getElementById('signupForm');
    const loginForm = document.getElementById('loginForm');
    const authPanel = document.getElementById('authPanel');
    const tracker = document.getElementById('tracker');
    const signOutBtn = document.getElementById('signOutBtn');
    const userEmailEl = document.getElementById('userEmail');
    const jobForm = document.getElementById('jobForm');
    const jobList = document.getElementById('jobList');
    const search = document.getElementById('search');
    const filterStatus = document.getElementById('filterStatus');

    function makeToken(length = 36) {
      const arr = new Uint8Array(length);
      crypto.getRandomValues(arr);
      return Array.from(arr).map(n => ("0" + n.toString(16)).slice(-2)).join("");
    }

    let currentUser = null;
    let jobsCache = [];

    // auth
    signupForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        await createUserWithEmailAndPassword(auth, signupEmail.value, signupPassword.value);
        alert('Account created — you are logged in.');
      } catch (err) { alert('Error: ' + err.message); }
    });

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        await signInWithEmailAndPassword(auth, loginEmail.value, loginPassword.value);
      } catch (err) { alert('Error: ' + err.message); }
    });

    signOutBtn.addEventListener('click', () => signOut(auth));

    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        authPanel.style.display = 'none';
        tracker.style.display = 'block';
        userEmailEl.textContent = user.email;
        startListeningJobs();
      } else {
        currentUser = null;
        authPanel.style.display = 'block';
        tracker.style.display = 'none';
        jobsCache = [];
        jobList.innerHTML = '<p class="small">Please sign in.</p>';
      }
    });

    function startListeningJobs(){
      const jobsRef = ref(db, 'jobs/' + currentUser.uid);
      onValue(jobsRef, (snap) => {
        jobsCache = [];
        if (!snap.exists()) {
          jobList.innerHTML = '<p class="small">No jobs yet.</p>';
          return;
        }
        snap.forEach(child => jobsCache.push({ id: child.key, ...child.val() }));
        renderJobs();
      });
    }

    jobForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const company = company.value.trim();
      const position = position.value.trim();
      const date = date.value;
      const status = status.value;
      const link = link.value.trim();
      const notes = notes.value.trim();
      const resumeFile = resume.files[0];

      try {
        const newJobRef = push(ref(db, 'jobs/' + currentUser.uid));
        await set(newJobRef, { company, position, date, status, link, notes, createdAt: Date.now() });
        const jobId = newJobRef.key;

        if (resumeFile) {
          const safeName = resumeFile.name.replace(/\s+/g,'_').replace(/[^\w.-]/g,'');
          const path = `resumes/${currentUser.uid}/${Date.now()}_${safeName}`;
          const fileRef = sRef(storage, path);
          await uploadBytes(fileRef, resumeFile);
          const url = await getDownloadURL(fileRef);
          await update(ref(db, 'jobs/' + currentUser.uid + '/' + jobId), { resume: url, resumeName: resumeFile.name, resumePath: path });
        }

        const token = makeToken(18);
        await set(ref(db, 'editTokens/' + token), { uid: currentUser.uid, jobId, createdAt: Date.now() });
        alert('Job added. Share this edit link:\n' + `${location.origin}/edit.html?token=${token}`);
        jobForm.reset();
      } catch (err) { alert('Failed: ' + err.message); }
    });

    function renderJobs(){
    const q = search.value.trim().toLowerCase();
    const sFilter = filterStatus.value;
    const filtered = jobsCache.filter(j =>
        (!q || j.company.toLowerCase().includes(q) || j.position.toLowerCase().includes(q)) &&
        (!sFilter || j.status === sFilter)
    );

    if (!filtered.length) {
        jobList.innerHTML = '<p class="small">No results</p>';
        return;
    }

    jobList.innerHTML = '';
    filtered.forEach(j => {
        const div = document.createElement('div');
        div.className = 'job';

        // Job info
        div.innerHTML = `
            <strong>${j.company} — ${j.position}</strong><br>
            <span class="small">${j.date}</span>
        `;

        // Status dropdown
        const statusSelect = document.createElement('select');
        ['Applied', 'Interviewing', 'Offer', 'Rejected'].forEach(opt => {
            const option = document.createElement('option');
            option.value = opt;
            option.textContent = opt;
            if(opt === j.status) option.selected = true;
            statusSelect.appendChild(option);
        });
        statusSelect.addEventListener('change', async () => {s
            try {
                await update(ref(db, 'jobs/' + currentUser.uid + '/' + j.id), { status: statusSelect.value });
            } catch(err) { alert('Failed to update status: ' + err.message); }
        });

        // Delete button
        const delBtn = document.createElement('button');
        delBtn.textContent = 'Delete';
        delBtn.className = 'btn btn-danger';
        delBtn.addEventListener('click', async () => {
            if(!confirm('Are you sure you want to delete this job?')) return;
            try {
                await remove(ref(db, 'jobs/' + currentUser.uid + '/' + j.id));
                if(j.resumePath) await deleteObject(sRef(storage, j.resumePath));
            } catch(err) { alert('Failed to delete: ' + err.message); }
        });

        const controlsDiv = document.createElement('div');
        controlsDiv.style.display = 'flex';
        controlsDiv.style.gap = '8px';
        controlsDiv.style.marginTop = '6px';
        controlsDiv.appendChild(statusSelect);
        controlsDiv.appendChild(delBtn);

        div.appendChild(controlsDiv);
        jobList.appendChild(div);
    });
}


    search.addEventListener('input', renderJobs);
    filterStatus.addEventListener('change', renderJobs);
</script>
</body>
</html>
