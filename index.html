<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Job Tracker — Dashboard</title>
    <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f0f8ff;margin:20px}
    h1{text-align:center}
    .container{max-width:900px;margin:0 auto}
    form{background:#fff;padding:12px;border-radius:6px;border:1px solid #dcdcdc;margin-bottom:12px}
    input,select,textarea,button{width:100%;padding:8px;margin-top:6px;box-sizing:border-box}
    .row{display:flex;gap:12px}
    .col{flex:1}
    #jobList{background:#fff;padding:12px;border-radius:6px;border:1px solid #dcdcdc}
    .job{padding:10px;border-bottom:1px solid #eee}
    .token-link{display:block;margin-top:6px;color:blue}
    .small{font-size:0.9em;color:#555}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .btn{padding:8px;border:none;border-radius:4px;cursor:pointer}
    .btn-danger{background:#ff4d4d;color:white}
    .btn-primary{background:#2b7cff;color:white}
  </style>

    hiiiii
</head>
<body>
<div class="container">
    <h1>Job/Internship Tracker — Dashboard</h1>

    <!-- Auth -->
    <div id="authPanel">
        <form id="signupForm">
            <h3>Create account</h3>
            <input id="signupEmail" type="email" placeholder="Email" required />
            <input id="signupPassword" type="password" placeholder="Password (min 6)" required />
            <button class="btn btn-primary" type="submit">Sign Up</button>
        </form>

        <form id="loginForm">
            <h3>Log in</h3>
            <input id="loginEmail" type="email" placeholder="Email" required />
            <input id="loginPassword" type="password" placeholder="Password" required />
            <button class="btn btn-primary" type="submit">Log In</button>
        </form>
    </div>

    <!-- Tracker (hidden until auth) -->
    <div id="tracker" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
                <strong id="userEmail"></strong>
            </div>
            <div class="controls">
                <button id="signOutBtn" class="btn">Sign out</button>
            </div>
        </div>

        <!-- Add job -->
        <form id="jobForm">
            <h3>Add job</h3>
            <input id="company" placeholder="Company" required />
            <input id="position" placeholder="Position" required />
            <div class="row">
                <div class="col">
                    <label class="small">Date applied</label>
                    <input id="date" type="date" required />
                </div>
                <div class="col">
                    <label class="small">Status</label>
                    <select id="status">
                        <option>Applied</option>
                        <option>Interviewing</option>
                        <option>Offer</option>
                        <option>Rejected</option>
                    </select>
                </div>
            </div>
            <input id="link" placeholder="Application link (optional)" />
            <textarea id="notes" rows="3" placeholder="Notes (optional)"></textarea>
            <label class="small">Resume (optional)</label>
            <input id="resume" type="file" accept=".pdf,.doc,.docx" />

            <button class="btn btn-primary" type="submit">Add job & generate edit link</button>
        </form>

        <!-- Filters -->
        <div style="display:flex;gap:8px;margin:10px 0">
            <input id="search" placeholder="Search company or position..." />
            <select id="filterStatus">
                <option value="">All statuses</option>
                <option>Applied</option>
                <option>Interviewing</option>
                <option>Offer</option>
                <option>Rejected</option>
            </select>
        </div>

        <!-- Jobs -->
        <div id="jobList">
            <p class="small">Loading...</p>
        </div>
    </div>

</div>

<script type="module">
  // Firebase imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
  import { getDatabase, ref, push, set, get, onValue, update, remove } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
  import { getStorage, ref as sRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-storage.js";

  // TODO: replace with your own Firebase config for production
  const firebaseConfig = {
    apiKey: "AIzaSyBSUy5xyp9JQ77cPnoJ7L_Ydh9-Kc0l1N8",
    authDomain: "job-internship-tracker.firebaseapp.com",
    databaseURL: "https://job-internship-tracker-default-rtdb.firebaseio.com",
    projectId: "job-internship-tracker",
    storageBucket: "job-internship-tracker.firebasestorage.app",
    messagingSenderId: "346187501673",
    appId: "1:346187501673:web:bb3d0a8fe36f92b56b92f8",
  };

  // init
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);
  const storage = getStorage(app);

  // UI refs
  const signupForm = document.getElementById('signupForm');
  const loginForm = document.getElementById('loginForm');
  const authPanel = document.getElementById('authPanel');
  const tracker = document.getElementById('tracker');
  const signOutBtn = document.getElementById('signOutBtn');
  const userEmailEl = document.getElementById('userEmail');

  const jobForm = document.getElementById('jobForm');
  const jobList = document.getElementById('jobList');
  const search = document.getElementById('search');
  const filterStatus = document.getElementById('filterStatus');

  // helpers
  function makeToken(length = 36) {
    // secure random token (URL-safe base64)
    const arr = new Uint8Array(length);
    crypto.getRandomValues(arr);
    return Array.from(arr).map(n => ("0" + n.toString(16)).slice(-2)).join("");
  }

  let currentUser = null;
  let jobsCache = [];

  // auth handlers
  signupForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('signupEmail').value;
    const pass = document.getElementById('signupPassword').value;
    try {
      await createUserWithEmailAndPassword(auth, email, pass);
      alert('Account created — you are logged in.');
    } catch (err) {
      console.error(err);
      alert('Error: ' + err.message);
    }
  });

  loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value;
    const pass = document.getElementById('loginPassword').value;
    try {
      await signInWithEmailAndPassword(auth, email, pass);
    } catch (err) {
      console.error(err);
      alert('Error: ' + err.message);
    }
  });

  signOutBtn.addEventListener('click', () => signOut(auth));

  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;
      authPanel.style.display = 'none';
      tracker.style.display = 'block';
      userEmailEl.textContent = user.email;
      startListeningJobs();
    } else {
      currentUser = null;
      authPanel.style.display = 'block';
      tracker.style.display = 'none';
      jobsCache = [];
      if (jobList) jobList.innerHTML = '<p class="small">Please sign in.</p>';
    }
  });

  // Listen to jobs for current user
  function startListeningJobs(){
    const jobsRef = ref(db, 'jobs/' + currentUser.uid);
    onValue(jobsRef, (snap) => {
      jobsCache = [];
      if (!snap.exists()) {
        jobList.innerHTML = '<p class="small">No jobs yet. Add one above.</p>';
        return;
      }
      snap.forEach(child => {
        jobsCache.push({ id: child.key, ...child.val() });
      });
      renderJobs();
    }, (err) => {
      console.error('listen error', err);
      jobList.innerHTML = '<p class="small">Failed to load jobs.</p>';
    });
  }

  // Add job: write job and create edit token entry
  jobForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const company = document.getElementById('company').value.trim();
    const position = document.getElementById('position').value.trim();
    const date = document.getElementById('date').value;
    const status = document.getElementById('status').value;
    const link = document.getElementById('link') ? document.getElementById('link').value.trim() : '';
    const notes = document.getElementById('notes') ? document.getElementById('notes').value.trim() : '';
    const resumeFile = document.getElementById('resume').files[0];

    if (!company || !position || !date) return alert('Please fill required fields');

    try {
      // create job under user's node
      const newJobRef = push(ref(db, 'jobs/' + currentUser.uid));
      const jobData = {
        company, position, date, status, link: link || '', notes: notes || '',
        resume: '', resumeName: '', createdAt: Date.now()
      };
      await set(newJobRef, jobData);
      const jobId = newJobRef.key;

      // upload resume if present
      if (resumeFile) {
        const safeName = resumeFile.name.replace(/\s+/g,'_').replace(/[^\w.-]/g,'');
        const path = `resumes/${currentUser.uid}/${Date.now()}_${safeName}`;
        const fileRef = sRef(storage, path);
        await uploadBytes(fileRef, resumeFile);
        const url = await getDownloadURL(fileRef);
        await update(ref(db, 'jobs/' + currentUser.uid + '/' + jobId), { resume: url, resumeName: resumeFile.name, resumePath: path });
      }

      // create edit token
      const token = makeToken(18);
      // store token => points to this user's job
      await set(ref(db, 'editTokens/' + token), {
        uid: currentUser.uid,
        jobId: jobId,
        createdAt: Date.now()
      });

      // show the edit link to the user (so they can share it with the company)
      const editUrl = `${location.origin}/edit.html?token=${token}`;
      // small UI feedback: append token link to newly added job if present in cache after render
      alert('Job added. Share this edit link with the company to let them update status:\n\n' + editUrl);

      jobForm.reset();
    } catch (err) {
      console.error('Add job failed', err);
      alert('Failed to add job: ' + (err.message || err));
    }
  });

  // Render jobs according to filters
  // Render jobs according to filters
function renderJobs(){
  const q = search.value.trim().toLowerCase();
  const sFilter = filterStatus.value;
  const filtered = jobsCache.filter(j => {
    const matchesText = !q || j.company.toLowerCase().includes(q) || j.position.toLowerCase().includes(q);
    const matchesStatus = !sFilter || j.status === sFilter;
    return matchesText && matchesStatus;
  });

  if (!filtered.length) {
    jobList.innerHTML = '<p class="small">No results</p>';
    return;
  }

  jobList.innerHTML = '';
  filtered.forEach(j => {
    const div = document.createElement('div');
    div.className = 'job';

    // status dropdown for YOU
    const statusSelect = document.createElement('select');
    ["Applied","Interviewing","Offer","Rejected"].forEach(opt => {
      const o = document.createElement('option');
      o.value = opt;
      o.textContent = opt;
      if (j.status === opt) o.selected = true;
      statusSelect.appendChild(o);
    });
    statusSelect.addEventListener('change', async () => {
      try {
        await update(ref(db, 'jobs/' + currentUser.uid + '/' + j.id), { status: statusSelect.value });
      } catch (err) {
        console.error(err);
        alert("Failed to update status: " + err.message);
      }
    });

    div.innerHTML = `
      <strong>${escapeHtml(j.company)} — ${escapeHtml(j.position)}</strong><br>
      <span class="small">${escapeHtml(j.date)}</span><br>
      ${j.link ? `<a href="${escapeAttr(j.link)}" target="_blank">🔗 Job Link</a><br>` : ''}
      ${j.notes ? `<em>Notes: ${escapeHtml(j.notes)}</em><br>` : ''}
    `;

    div.appendChild(statusSelect);

    if (j.resume) {
      const a = document.createElement('a');
      a.href = j.resume;
      a.textContent = '📄 ' + (j.resumeName || 'Resume');
      a.target = '_blank';
      a.className = 'resume-link';
      div.appendChild(a);
    }

    // controls (edit link + delete)
    const controls = document.createElement('div');
    controls.className = 'controls';

    // regenerate edit link (for company)
    const genBtn = document.createElement('button');
    genBtn.className = 'btn';
    genBtn.textContent = 'Get/Edit Link';
    genBtn.addEventListener('click', async () => {
      try {
        const token = makeToken(18);
        await set(ref(db, 'editTokens/' + token), { uid: currentUser.uid, jobId: j.id, createdAt: Date.now() });
        const editUrl = `${location.origin}/edit.html?token=${token}`;
        prompt('Share this link with the company (copy to clipboard):', editUrl);
      } catch (err) {
        console.error(err);
        alert('Failed to create edit link: ' + err.message);
      }
    });
    controls.appendChild(genBtn);

    // delete
    const delBtn = document.createElement('button');
    delBtn.className = 'btn btn-danger';
    delBtn.textContent = 'Delete';
    delBtn.addEventListener('click', async () => {
      if (!confirm('Delete this job?')) return;
      try {
        if (j.resumePath) {
          await deleteObject(sRef(storage, j.resumePath)).catch(()=>{/*ignore*/});
        }
        await remove(ref(db, 'jobs/' + currentUser.uid + '/' + j.id));
      } catch (err) {
        console.error(err);
        alert('Delete failed: ' + err.message);
      }
    });
    controls.appendChild(delBtn);

    div.appendChild(controls);
    jobList.appendChild(div);
  });
}


  // filter events
  search.addEventListener('input', renderJobs);
  filterStatus.addEventListener('change', renderJobs);

  // simple escape helpers for safety
  function escapeHtml(s){ return s ? s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') : ''; }
  function escapeAttr(s){ return s ? s.replace(/"/g,'&quot;') : s; }

</script>
</body>
</html>
